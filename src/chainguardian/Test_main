# Made by Zachary Mangiafesto
import tkinter as tk
from tkinter import ttk
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
from encryptor import load_store, save_store
from portfolio import Portfolio
from market_data import prices_coingecko, fetch_fear_greed
from top_wallets import get_whale_activity
from thresholds import profit_take_signal
from graphs import build_unrealized_bar, build_distribution_pie
import threading, time

class ChainGuardianApp(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Chain Guardian Dashboard")
        self.geometry("1200x800")
        self.store = load_store()
        self.portfolio = Portfolio(self.store)
        self.refresh_seconds = int(self.store.get("settings", {}).get("refresh_seconds", 30))
        self._build_ui()
        self._start_refresh()

    def _build_ui(self):
        # Top summary bar
        # Tabs: Portfolio, Whale Watch, Orders, Settings
        # Portfolio tab: table + charts
        # Whale tab: text panel
        # Orders tab: raw order list
        # Settings tab: API keys, refresh interval, etc.
        pass  # Fill in with layout code from previous message

    def _start_refresh(self):
        self._stop = False
        def loop():
            while not self._stop:
                try:
                    self._refresh()
                except Exception as e:
                    print("Refresh error:", e)
                time.sleep(self.refresh_seconds)
        threading.Thread(target=loop, daemon=True).start()

    def _refresh(self):
        # Reload store, update portfolio, fetch prices, compute stats
        # Update GUI widgets: table, charts, summary cards, whale panel
        pass  # Use the refresh logic from earlier

    def stop(self):
        self._stop = True

def main():
    app = ChainGuardianApp()
    app.protocol("WM_DELETE_WINDOW", lambda: (app.stop(), app.destroy()))
    app.mainloop()

if __name__ == "__main__":
    main()
